<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·∫° T·∫ßng Viewer - Cesium 3D Tiles</title>
    
    <!-- Cesium CSS -->
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.110/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    
    <style>
        html, body, #cesiumContainer {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        #controlPanel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(42, 42, 42, 0.9);
            padding: 15px;
            border-radius: 5px;
            color: white;
            font-family: Arial, sans-serif;
            max-width: 300px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
        }
        
        #controlPanel h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
            border-bottom: 1px solid #666;
            padding-bottom: 5px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .control-group button {
            width: 100%;
            padding: 8px;
            margin-bottom: 5px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .control-group button:hover {
            background: #45a049;
        }
        
        .control-group button.active {
            background: #2196F3;
        }
        
        .province-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .province-item {
            padding: 5px;
            margin: 2px 0;
            background: #555;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .province-item:hover {
            background: #666;
        }
        
        #loadingIndicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            display: none;
            z-index: 2000;
        }
        
        .info-text {
            font-size: 11px;
            color: #ccc;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    
    <div id="loadingIndicator">
        <div>ƒêang t·∫£i d·ªØ li·ªáu...</div>
    </div>
    
    <div id="controlPanel">
        <h3>üó∫Ô∏è H·∫° T·∫ßng Viewer</h3>
        
        <div class="control-group">
            <button id="loadAllBtn">T·∫£i t·∫•t c·∫£ t·ªânh</button>
            <button id="loadDaNangBtn">T·∫£i ƒê√† N·∫µng</button>
            <button id="clearAllBtn">X√≥a t·∫•t c·∫£</button>
        </div>
        
        <div class="control-group">
            <label>ƒêi·ªÅu ch·ªânh ƒë·ªô cao m√¥ h√¨nh:</label>
            <input type="range" id="heightOffset" min="-100" max="100" value="0" step="1" style="width: 100%;">
            <div style="text-align: center; font-size: 11px;"><span id="heightValue">0</span> m</div>
        </div>
        
        <div class="control-group">
            <label>C√°c t·ªânh ƒë√£ t·∫£i:</label>
            <div id="loadedTilesets" class="info-text">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
        </div>
        
        <div class="info-text">
            <strong>H∆∞·ªõng d·∫´n:</strong><br>
            ‚Ä¢ Click chu·ªôt tr√°i + k√©o: Xoay<br>
            ‚Ä¢ Cu·ªôn chu·ªôt: Zoom<br>
            ‚Ä¢ Click chu·ªôt ph·∫£i + k√©o: Di chuy·ªÉn<br>
            ‚Ä¢ Gi·ªØ Ctrl + Click tr√°i: Nghi√™ng
        </div>
    </div>

    <!-- Cesium JavaScript -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.110/Build/Cesium/Cesium.js"></script>
    
    <script>
        // Thi·∫øt l·∫≠p Cesium Ion access token
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJjMmU1Zjc0Ny1kMTZhLTRhYmMtOGFjYi1hOWU1MjlhYmEzNmQiLCJpZCI6MzE5NTA2LCJpYXQiOjE3NTMyNDMwODB9.k4KeeDH7fAto4Orfeva9-sJuvQTLoSELhItVYsochBs';
        
        // Kh·ªüi t·∫°o Cesium Viewer
        const viewer = new Cesium.Viewer('cesiumContainer', {
            terrainProvider: Cesium.CesiumTerrainProvider(),
            timeline: false,
            animation: false,
            geocoder: true,
            homeButton: true,
            sceneModePicker: true,
            baseLayerPicker: true,
            navigationHelpButton: true,
            fullscreenButton: true,
            vrButton: false,
            infoBox: true,
            selectionIndicator: true,
            // B·∫≠t ƒë·ªï b√≥ng ƒë·ªÉ m√¥ h√¨nh 3D ƒë·∫πp h∆°n
            shadows: true
        });
        
        // C·∫•u h√¨nh ƒë·ªÉ t·∫£i GLB models t·ªët h∆°n
        viewer.scene.light = new Cesium.DirectionalLight({
            direction: new Cesium.Cartesian3(0.2, 0.5, -0.8)
        });
        
        // B·∫≠t depth testing ƒë·ªÉ c√°c model hi·ªÉn th·ªã ƒë√∫ng
        viewer.scene.globe.depthTestAgainstTerrain = true;
        
        // L∆∞u tr·ªØ c√°c tileset ƒë√£ t·∫£i
        const loadedTilesets = new Map();
        let heightOffset = 0;
        
        // ƒê∆∞·ªùng d·∫´n g·ªëc ƒë·∫øn th∆∞ m·ª•c tileset
        const BASE_URL = '../wwwroot/Tileset_Ha_tang/';
        
        // H√†m hi·ªÉn th·ªã loading
        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        }
        
        // H√†m c·∫≠p nh·∫≠t danh s√°ch tileset ƒë√£ t·∫£i
        function updateLoadedList() {
            const listElement = document.getElementById('loadedTilesets');
            if (loadedTilesets.size === 0) {
                listElement.textContent = 'Ch∆∞a c√≥ d·ªØ li·ªáu';
            } else {
                const names = Array.from(loadedTilesets.keys());
                listElement.textContent = names.join(', ');
            }
        }
        
        // H√†m t·∫£i tileset
        async function loadTileset(url, name) {
            try {
                showLoading(true);
                
                // Ki·ªÉm tra n·∫øu ƒë√£ t·∫£i r·ªìi th√¨ kh√¥ng t·∫£i l·∫°i
                if (loadedTilesets.has(name)) {
                    console.log(`Tileset ${name} ƒë√£ ƒë∆∞·ª£c t·∫£i`);
                    showLoading(false);
                    return loadedTilesets.get(name);
                }
                
                console.log(`ƒêang t·∫£i tileset: ${url}`);
                
                const tileset = await Cesium.Cesium3DTileset.fromUrl(url, {
                    maximumScreenSpaceError: 16,
                    maximumMemoryUsage: 512,
                    // C·∫•u h√¨nh ƒë·ªÉ t·∫£i GLB models
                    skipLevelOfDetail: false,
                    baseScreenSpaceError: 1024,
                    skipScreenSpaceErrorFactor: 16,
                    skipLevels: 1,
                    immediatelyLoadDesiredLevelOfDetail: false,
                    loadSiblings: false,
                    cullWithChildrenBounds: true
                });
                
                // ƒê·∫£m b·∫£o GLB models ƒë∆∞·ª£c render ƒë√∫ng
                tileset.style = new Cesium.Cesium3DTileStyle({
                    color: "color('white')",
                    show: true
                });
                
                // Th√™m tileset v√†o scene
                viewer.scene.primitives.add(tileset);
                
                // Th√™m event listener ƒë·ªÉ ki·ªÉm tra loading
                tileset.allTilesLoaded.addEventListener(() => {
                    console.log(`‚úì T·∫•t c·∫£ tiles c·ªßa ${name} ƒë√£ ƒë∆∞·ª£c t·∫£i`);
                });
                
                tileset.loadProgress.addEventListener((numberOfPendingRequests, numberOfTilesProcessing) => {
                    if ((numberOfPendingRequests === 0) && (numberOfTilesProcessing === 0)) {
                        console.log(`‚úì Ho√†n th√†nh t·∫£i: ${name}`);
                    }
                });
                
                tileset.tileLoad.addEventListener((tile) => {
                    console.log(`  - ƒê√£ t·∫£i tile:`, tile.content?.url || 'unknown');
                });
                
                tileset.tileFailed.addEventListener((error) => {
                    console.error(`‚úó L·ªói t·∫£i tile:`, error);
                });
                
                // √Åp d·ª•ng height offset n·∫øu c√≥
                if (heightOffset !== 0) {
                    applyHeightOffsetToTileset(tileset, heightOffset);
                }
                
                // L∆∞u tileset
                loadedTilesets.set(name, tileset);
                updateLoadedList();
                
                // Zoom ƒë·∫øn tileset ƒë·∫ßu ti√™n ƒë∆∞·ª£c t·∫£i
                if (loadedTilesets.size === 1) {
                    viewer.zoomTo(tileset);
                }
                
                console.log(`‚úì ƒê√£ t·∫£i th√†nh c√¥ng: ${name}`);
                showLoading(false);
                
                return tileset;
                
            } catch (error) {
                console.error(`L·ªói khi t·∫£i tileset ${name}:`, error);
                showLoading(false);
                alert(`Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ${name}. Vui l√≤ng ki·ªÉm tra console ƒë·ªÉ bi·∫øt chi ti·∫øt.`);
            }
        }
        
        // H√†m √°p d·ª•ng height offset cho tileset
        function applyHeightOffsetToTileset(tileset, offset) {
            const cartographic = Cesium.Cartographic.fromCartesian(
                tileset.boundingSphere.center
            );
            const surface = Cesium.Cartesian3.fromRadians(
                cartographic.longitude,
                cartographic.latitude,
                0.0
            );
            const offsetVector = Cesium.Cartesian3.fromRadians(
                cartographic.longitude,
                cartographic.latitude,
                offset
            );
            const translation = Cesium.Cartesian3.subtract(
                offsetVector,
                surface,
                new Cesium.Cartesian3()
            );
            tileset.modelMatrix = Cesium.Matrix4.fromTranslation(translation);
        }
        
        // H√†m t·∫£i t·∫•t c·∫£ c√°c t·ªânh
        async function loadAllProvinces() {
            const url = BASE_URL + 'vietnam_provinces.json';
            await loadTileset(url, 'T·∫•t c·∫£ c√°c t·ªânh');
        }
        
        // H√†m t·∫£i ri√™ng ƒê√† N·∫µng
        async function loadDaNang() {
            const url = BASE_URL + 'Tinh/danang.json';
            const tileset = await loadTileset(url, 'ƒê√† N·∫µng');
            
            // Zoom ƒë·∫øn ƒê√† N·∫µng
            if (tileset) {
                viewer.zoomTo(tileset, new Cesium.HeadingPitchRange(
                    0.0,
                    -0.5,
                    tileset.boundingSphere.radius * 2.0
                ));
            }
        }
        
        // H√†m x√≥a t·∫•t c·∫£ tileset
        function clearAllTilesets() {
            loadedTilesets.forEach((tileset, name) => {
                viewer.scene.primitives.remove(tileset);
                console.log(`ƒê√£ x√≥a: ${name}`);
            });
            loadedTilesets.clear();
            updateLoadedList();
        }
        
        // Event listeners cho c√°c n√∫t
        document.getElementById('loadAllBtn').addEventListener('click', loadAllProvinces);
        document.getElementById('loadDaNangBtn').addEventListener('click', loadDaNang);
        document.getElementById('clearAllBtn').addEventListener('click', clearAllTilesets);
        
        // Event listener cho height offset slider
        document.getElementById('heightOffset').addEventListener('input', (event) => {
            heightOffset = parseFloat(event.target.value);
            document.getElementById('heightValue').textContent = heightOffset;
            
            // √Åp d·ª•ng offset cho t·∫•t c·∫£ tileset ƒë√£ t·∫£i
            loadedTilesets.forEach((tileset) => {
                applyHeightOffsetToTileset(tileset, heightOffset);
            });
        });
        
        // Thi·∫øt l·∫≠p camera ban ƒë·∫ßu t·∫°i Vi·ªát Nam
        viewer.camera.setView({
            destination: Cesium.Cartesian3.fromDegrees(108.2022, 16.0544, 50000), // ƒê√† N·∫µng
            orientation: {
                heading: Cesium.Math.toRadians(0),
                pitch: Cesium.Math.toRadians(-45),
                roll: 0.0
            }
        });
        
        // Th√™m x·ª≠ l√Ω click v√†o ƒë·ªëi t∆∞·ª£ng 3D
        viewer.screenSpaceEventHandler.setInputAction(function(movement) {
            const pickedFeature = viewer.scene.pick(movement.position);
            if (Cesium.defined(pickedFeature)) {
                console.log('ƒê√£ click v√†o:', pickedFeature);
                
                // Hi·ªÉn th·ªã th√¥ng tin n·∫øu c√≥
                if (pickedFeature.getProperty) {
                    const properties = pickedFeature.getPropertyNames();
                    if (properties.length > 0) {
                        let info = '<table class="cesium-infoBox-defaultTable"><tbody>';
                        properties.forEach(prop => {
                            const value = pickedFeature.getProperty(prop);
                            info += `<tr><th>${prop}</th><td>${value}</td></tr>`;
                        });
                        info += '</tbody></table>';
                        
                        viewer.selectedEntity = new Cesium.Entity({
                            name: 'Th√¥ng tin',
                            description: info
                        });
                    }
                }
            }
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
        
        // T·ª± ƒë·ªông t·∫£i ƒê√† N·∫µng khi kh·ªüi ƒë·ªông
        console.log('üöÄ Cesium Viewer ƒë√£ s·∫µn s√†ng!');
        console.log('üìç S·∫µn s√†ng t·∫£i d·ªØ li·ªáu 3D Tiles t·ª´:', BASE_URL);
        
        // T·∫£i ƒê√† N·∫µng m·∫∑c ƒë·ªãnh
        loadDaNang();
        
    </script>
</body>
</html>
